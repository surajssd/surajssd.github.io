<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>HostPath volumes and it&#39;s problems | Suraj Deshmukh</title>
<meta name="keywords" content="kubernetes, openshift, hostpath, security">
<meta name="description" content="Kubernetes HostPath volume good way to nuke your Kubernetes Nodes">
<meta name="author" content="Suraj Deshmukh">
<link rel="canonical" href="https://suraj.io/post/k8s-hostpat-nuke-nodes/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://suraj.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://suraj.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://suraj.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://suraj.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://suraj.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://suraj.io/post/k8s-hostpat-nuke-nodes/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-97006720-1', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="HostPath volumes and it&#39;s problems" />
<meta property="og:description" content="Kubernetes HostPath volume good way to nuke your Kubernetes Nodes" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://suraj.io/post/k8s-hostpat-nuke-nodes/" />
<meta property="og:image" content="https://suraj.io/images/papermod-cover.png" />
<meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-09-10T01:00:51+05:30" />
<meta property="article:modified_time" content="2018-09-10T01:00:51+05:30" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://suraj.io/images/papermod-cover.png" />
<meta name="twitter:title" content="HostPath volumes and it&#39;s problems"/>
<meta name="twitter:description" content="Kubernetes HostPath volume good way to nuke your Kubernetes Nodes"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://suraj.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "HostPath volumes and it's problems",
      "item": "https://suraj.io/post/k8s-hostpat-nuke-nodes/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "HostPath volumes and it's problems",
  "name": "HostPath volumes and it\u0027s problems",
  "description": "Kubernetes HostPath volume good way to nuke your Kubernetes Nodes",
  "keywords": [
    "kubernetes", "openshift", "hostpath", "security"
  ],
  "articleBody": "This post will demonstrate how Kubernetes HostPath volumes can help you get access to the Kubernetes nodes. Atleast you can play with the filesystem of the node on which you pod is scheduled on. You can get access to other containers running on the host, certificates of the kubelet, etc.\nI have a 3-master and 3-node cluster and setup using this script, running in a Vagrant environment.\nAll the nodes are in ready state:\n$ kubectl get nodes -o wide NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME worker-0 Ready 24m v1.11.2 192.168.199.20 Ubuntu 18.04.1 LTS 4.15.0-33-generic cri-o://1.11.2 worker-1 Ready 23m v1.11.2 192.168.199.21 Ubuntu 18.04.1 LTS 4.15.0-33-generic cri-o://1.11.2 worker-2 Ready 21m v1.11.2 192.168.199.22 Ubuntu 18.04.1 LTS 4.15.0-33-generic cri-o://1.11.2 The deployment looks like this:\n$ cat deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: labels: run: web name: web spec: replicas: 1 selector: matchLabels: run: web template: metadata: labels: run: web spec: containers: - image: centos/httpd name: web volumeMounts: - mountPath: /web name: test-volume volumes: - name: test-volume hostPath: path: / Above you can see we are mounting / of the host inside pod at /web. This is our gateway to host’s file system. Let’s deploy this:\n$ kubectl apply -f deployment.yaml deployment.apps/web created And now that pod has started:\n$ kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE web-66cdf67bbc-44zhj 1/1 Running 0 4m 10.38.0.1 worker-2 Getting inside the pod and checking out the mounted directory:\n$ kubectl exec -it web-66cdf67bbc-44zhj bash [root@web-66cdf67bbc-44zhj /]# cd /web [root@web-66cdf67bbc-44zhj web]# ls bin boot dev etc home initrd.img initrd.img.old lib lib64 lost+found media mnt opt proc root run sbin snap srv sys tmp usr vagrant var vmlinuz vmlinuz.old Now we can either chroot into this and see the output of ps.\n[root@web-66cdf67bbc-44zhj ~]# chroot /web # ps aufx USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 2 0.0 0.0 0 0 ? S 05:15 0:00 [kthreadd] root 4 0.0 0.0 0 0 ? I\u003c 05:15 0:00 \\_ [kworker/0:0H] root 6 0.0 0.0 0 0 ? I\u003c 05:15 0:00 \\_ [mm_percpu_wq] root 7 0.0 0.0 0 0 ? S 05:15 0:00 \\_ [ksoftirqd/0] root 8 0.0 0.0 0 0 ? I 05:15 0:00 \\_ [rcu_sched] root 9 0.0 0.0 0 0 ? I 05:15 0:00 \\_ [rcu_bh] root 10 0.0 0.0 0 0 ? S 05:15 0:00 \\_ [migration/0] root 11 0.0 0.0 0 0 ? S 05:15 0:00 \\_ [watchdog/0] root 12 0.0 0.0 0 0 ? S 05:15 0:00 \\_ [cpuhp/0] Or you can just delete the entire root, a.k.a. nuking the node.\n# rm -rf --no-preserve-root / Now if you look at the nodes:\n$ kubectl get nodes -o wide NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME worker-0 Ready 30m v1.11.2 192.168.199.20 Ubuntu 18.04.1 LTS 4.15.0-33-generic cri-o://1.11.2 worker-1 Ready 29m v1.11.2 192.168.199.21 Ubuntu 18.04.1 LTS 4.15.0-33-generic cri-o://1.11.2 worker-2 NotReady 27m v1.11.2 192.168.199.22 Unknown 4.15.0-33-generic cri-o://Unknown The last node worker-2 is in NotReady state. We have successfully made one node unusable. Now that one node is gone your pod will be scheduled on another node, where you can do similar stuff.\n$ kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE NOMINATED NODE web-66cdf67bbc-44zhj 0/1 Unknown 0 20m 10.38.0.1 worker-2 web-66cdf67bbc-b22xn 1/1 Running 0 8m 10.32.0.2 worker-0 As you can see above the pod is re-scheduled on node worker-0. And we can do same set of steps to make worker-0 unusable.\nDeleting the deployment to cleanup.\n$ kubectl delete deployment web deployment.extensions \"web\" deleted Stopping this attack using PodSecurityPolicy Now as a cluster admin how can you prevent this from happening? You can create something called as PodSecurityPolicy. This let’s you define what kind of pods be created. Or what permissions pod can request. Enable admission controller for this, read about it here.\nHere is an example PodSecurityPolicy:\n$ cat podsecuritypolicy.yaml apiVersion: policy/v1beta1 kind: PodSecurityPolicy metadata: name: example spec: seLinux: rule: RunAsAny supplementalGroups: rule: RunAsAny runAsUser: rule: RunAsAny fsGroup: rule: RunAsAny volumes: - '*' privileged: false # Don't allow privileged pods! allowedHostPaths: - pathPrefix: /foo readOnly: true In above example, we are restricting access to hostPath a pod can request. Here the path that is allowed is /foo and has readOnly access to the underlying file system.\nCreate PodSecurityPolicy using above file:\n$ kubectl apply -f podsecuritypolicy.yaml podsecuritypolicy.policy/example created To enable this policy we need to create few more objects, a Role and RoleBinding.\nRole:\n$ cat role.yaml kind: Role apiVersion: rbac.authorization.k8s.io/v1 metadata: name: authorize-hostpath rules: - apiGroups: ['policy'] resources: ['podsecuritypolicies'] verbs: ['use'] resourceNames: - example This Role will allow usage of policy that we created above.\nCreate Role:\n$ kubectl apply -f role.yaml role.rbac.authorization.k8s.io/authorize-hostpath created RoleBinding:\n$ cat rolebinding.yaml kind: RoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: auth-hostpath roleRef: kind: Role name: authorize-hostpath apiGroup: rbac.authorization.k8s.io subjects: # Authorize all service accounts in a namespace: - kind: Group apiGroup: rbac.authorization.k8s.io name: system:serviceaccounts This RoleBinding will bind the Role above and all the ServiceAccounts in current namespace.\nCreate RoleBinding:\n$ kubectl create -f rolebinding.yaml rolebinding.rbac.authorization.k8s.io/auth-hostpath created Now that we have required permissions in place, try to re-create the deployment:\n$ kubectl apply -f deployment.yaml deployment.apps/web created The pod is not created and in events you can see an error as Error creating: pods \"web-66cdf67bbc-\" is forbidden: unable to validate against any pod security policy: [spec.volumes[0].hostPath.pathPrefix: Invalid value: \"/\": is not allowed to be used]:\n$ kubectl get events LAST SEEN FIRST SEEN COUNT NAME KIND SUBOBJECT TYPE REASON SOURCE MESSAGE ... 6s 17s 12 web-66cdf67bbc.15530e83fd4f8592 ReplicaSet Warning FailedCreate replicaset-controller Error creating: pods \"web-66cdf67bbc-\" is forbidden: unable to validate against any pod security policy: [spec.volumes[0].hostPath.pathPrefix: Invalid value: \"/\": is not allowed to be used] This error is due to the fact that we have allowed hostPath to be only under /foo and in the original file it is set to /.\nNow change in deployment.yaml file at path deployment.spec.template.spec.volumes[0].hostPath.path from / to /foo and apply again:\n$ kubectl apply -f deployment.yaml deployment.apps/web configured You can see another error Error creating: pods \"web-85cb548b47-\" is forbidden: unable to validate against any pod security policy: [spec.containers[0].volumeMounts[0].readOnly: Invalid value: false: must be read-only]:\n$ kubectl get events LAST SEEN FIRST SEEN COUNT NAME KIND SUBOBJECT TYPE REASON SOURCE MESSAGE ... 5s 15s 12 web-85cb548b47.15530eb0c27c6122 ReplicaSet Warning FailedCreate replicaset-controller Error creating: pods \"web-85cb548b47-\" is forbidden: unable to validate against any pod security policy: [spec.containers[0].volumeMounts[0].readOnly: Invalid value: false: must be read-only] This is because in the volumeMount’s readOnly we have used in container has no value defined, which means it defaults to false and in PodSecurityPolicy we have defaulted the hostPath to be readOnly.\nSo change deployment.spec.template.spec.containers[0].volumeMounts[0].readOnly to true. And manifest should look like following:\n$ cat deployment.yaml apiVersion: apps/v1 kind: Deployment metadata: labels: run: web name: web spec: replicas: 1 selector: matchLabels: run: web template: metadata: labels: run: web spec: containers: - image: centos/httpd name: web volumeMounts: - mountPath: /web name: test-volume readOnly: true volumes: - name: test-volume hostPath: path: /foo Now if you re-deploy the app:\n$ kubectl apply -f deployment.yaml deployment.apps/web configured The pod is scheduled and created:\n$ kubectl get pods NAME READY STATUS RESTARTS AGE web-7b77459d6b-kbqm8 1/1 Running 0 7s Now if you exec into this pod and try to do something, you can see nothing happens:\n$ kubectl exec -it web-7b77459d6b-kbqm8 bash [root@web-7b77459d6b-kbqm8 /]# cd /web/ [root@web-7b77459d6b-kbqm8 web]# ls [root@web-7b77459d6b-kbqm8 web]# touch file.txt touch: cannot touch 'file.txt': Read-only file system So this is really good feature you can use to stop someone from nuking your cluster.\nStopping this attack using SELinux Above setup of the Kubernetes cluster had a Ubuntu based machines, now I have a Kubernetes cluster that is setup on Fedora which supports SELinux.\nYou can setup this cluster following steps in this post.\nNote: This is a simple cluster setup without PodSecurityPolicy.\nOnce you have the cluster running:\n$ kubectl get nodes -o wide NAME STATUS ROLES AGE VERSION INTERNAL-IP EXTERNAL-IP OS-IMAGE KERNEL-VERSION CONTAINER-RUNTIME fedora Ready master 23m v1.11.2 10.0.2.15 Fedora 28 (Cloud Edition) 4.16.3-301.fc28.x86_64 docker://1.13.1 Lets follow the same set of steps of creating the deployment:\n$ kubectl apply -f deployment.yaml deployment.apps/web created The pod is created:\n$ kubectl get pods NAME READY STATUS RESTARTS AGE web-66cdf67bbc-t9n7m 1/1 Running 0 28s Getting into the machine:\n$ kubectl exec -it web-66cdf67bbc-t9n7m bash [root@web-66cdf67bbc-t9n7m /]# [root@web-66cdf67bbc-t9n7m /]# cd /web/ [root@web-66cdf67bbc-t9n7m web]# ls bin boot dev etc home lib lib64 lost+found media mnt opt proc root run sbin srv sys tmp usr vagrant var [root@web-66cdf67bbc-t9n7m web]# touch file.txt touch: cannot touch 'file.txt': Permission denied As you can see if you go to the root of host which is mounted at /web and try to create new file, it fails. This event will be logged into the SELinux audit logs. On host if you run following you will see logs:\n# ausearch -m avc ---- time-\u003eTue Sep 11 06:41:54 2018 type=AVC msg=audit(1536648114.522:985): avc: denied { write } for pid=15775 comm=\"touch\" name=\"/\" dev=\"sda1\" ino=2 scontext=system_u:system_r:container_t:s0:c230,c784 tcontext=system_u:object_r:root_t:s0 tclass=dir permissive=0 Here simple SELinux has stopped the container from writing into places it shouldn’t. Compared to PodSecurityPolicy (which is a beta feature in k8s 1.11), SELinux can help you right away if you are using older Kubernetes cluster and are on CentOS or RHEL.\nReferences Multi node Kubernetes setup used here Pod Security Policies Securing a Cluster hostPath volumes Enabling Admission controller SELinux denials Single node cluster with SELinux used here ",
  "wordCount" : "1572",
  "inLanguage": "en",
  "image": "https://suraj.io/images/papermod-cover.png","datePublished": "2018-09-10T01:00:51+05:30",
  "dateModified": "2018-09-10T01:00:51+05:30",
  "author":{
    "@type": "Person",
    "name": "Suraj Deshmukh"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://suraj.io/post/k8s-hostpat-nuke-nodes/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Suraj Deshmukh",
    "logo": {
      "@type": "ImageObject",
      "url": "https://suraj.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://suraj.io/" accesskey="h" title="Suraj Deshmukh (Alt + H)">Suraj Deshmukh</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://suraj.io/post" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/archives" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/series" title="Series">
                    <span>Series</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/search" title="Search 🔍">
                    <span>Search 🔍</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://suraj.io/">Home</a>&nbsp;»&nbsp;<a href="https://suraj.io/post/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      HostPath volumes and it&#39;s problems
    </h1>
    <div class="post-description">
      Kubernetes HostPath volume good way to nuke your Kubernetes Nodes
    </div>
    <div class="post-meta"><span title='2018-09-10 01:00:51 +0530 +0530'>September 10, 2018</span>&nbsp;·&nbsp;8 min&nbsp;·&nbsp;Suraj Deshmukh&nbsp;|&nbsp;<a href="https://github.com/surajssd/blog_contents/blob/master/content/post/k8s-hostpat-nuke-nodes.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#stopping-this-attack-using-podsecuritypolicy" aria-label="Stopping this attack using PodSecurityPolicy">Stopping this attack using PodSecurityPolicy</a></li>
                <li>
                    <a href="#stopping-this-attack-using-selinux" aria-label="Stopping this attack using SELinux">Stopping this attack using SELinux</a></li>
                <li>
                    <a href="#references" aria-label="References">References</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>This post will demonstrate how Kubernetes <a href="https://kubernetes.io/docs/concepts/storage/volumes/#hostpath"><code>HostPath</code></a> volumes can help you get access to the Kubernetes nodes. Atleast you can play with the filesystem of the node on which you pod is scheduled on. You can get access to other containers running on the host, certificates of the kubelet, etc.</p>
<p>I have a 3-master and 3-node cluster and setup using <a href="https://github.com/kinvolk/kubernetes-the-hard-way-vagrant/blob/master/scripts/setup">this script</a>, running in a Vagrant environment.</p>
<p>All the nodes are in ready state:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get nodes -o wide
</span></span><span class="line"><span class="cl">NAME       STATUS    ROLES     AGE       VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
</span></span><span class="line"><span class="cl">worker-0   Ready     &lt;none&gt;    24m       v1.11.2   192.168.199.20   &lt;none&gt;        Ubuntu 18.04.1 LTS   4.15.0-33-generic   cri-o://1.11.2
</span></span><span class="line"><span class="cl">worker-1   Ready     &lt;none&gt;    23m       v1.11.2   192.168.199.21   &lt;none&gt;        Ubuntu 18.04.1 LTS   4.15.0-33-generic   cri-o://1.11.2
</span></span><span class="line"><span class="cl">worker-2   Ready     &lt;none&gt;    21m       v1.11.2   192.168.199.22   &lt;none&gt;        Ubuntu 18.04.1 LTS   4.15.0-33-generic   cri-o://1.11.2
</span></span></code></pre></div><p>The deployment looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">$ cat deployment.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">centos/httpd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span></code></pre></div><p>Above you can see we are mounting <code>/</code> of the host inside pod at <code>/web</code>. This is our gateway to host&rsquo;s file system. Let&rsquo;s deploy this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f deployment.yaml
</span></span><span class="line"><span class="cl">deployment.apps/web created
</span></span></code></pre></div><p>And now that pod has started:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods -o wide
</span></span><span class="line"><span class="cl">NAME                   READY     STATUS    RESTARTS   AGE       IP          NODE       NOMINATED NODE
</span></span><span class="line"><span class="cl">web-66cdf67bbc-44zhj   1/1       Running   <span class="m">0</span>          4m        10.38.0.1   worker-2   &lt;none&gt;
</span></span></code></pre></div><p>Getting inside the pod and checking out the mounted directory:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl <span class="nb">exec</span> -it web-66cdf67bbc-44zhj bash
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@web-66cdf67bbc-44zhj /<span class="o">]</span><span class="c1"># cd /web</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@web-66cdf67bbc-44zhj web<span class="o">]</span><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl">bin  boot  dev  etc  home  initrd.img  initrd.img.old  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  snap  srv  sys  tmp  usr  vagrant  var  vmlinuz  vmlinuz.old
</span></span></code></pre></div><p>Now we can either <code>chroot</code> into this and see the output of <code>ps</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">[</span>root@web-66cdf67bbc-44zhj ~<span class="o">]</span><span class="c1"># chroot /web</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ps aufx</span>
</span></span><span class="line"><span class="cl">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span class="line"><span class="cl">root         <span class="m">2</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        S    05:15   0:00 <span class="o">[</span>kthreadd<span class="o">]</span>
</span></span><span class="line"><span class="cl">root         <span class="m">4</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        I&lt;   05:15   0:00  <span class="se">\_</span> <span class="o">[</span>kworker/0:0H<span class="o">]</span>
</span></span><span class="line"><span class="cl">root         <span class="m">6</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        I&lt;   05:15   0:00  <span class="se">\_</span> <span class="o">[</span>mm_percpu_wq<span class="o">]</span>
</span></span><span class="line"><span class="cl">root         <span class="m">7</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        S    05:15   0:00  <span class="se">\_</span> <span class="o">[</span>ksoftirqd/0<span class="o">]</span>
</span></span><span class="line"><span class="cl">root         <span class="m">8</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        I    05:15   0:00  <span class="se">\_</span> <span class="o">[</span>rcu_sched<span class="o">]</span>
</span></span><span class="line"><span class="cl">root         <span class="m">9</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        I    05:15   0:00  <span class="se">\_</span> <span class="o">[</span>rcu_bh<span class="o">]</span>
</span></span><span class="line"><span class="cl">root        <span class="m">10</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        S    05:15   0:00  <span class="se">\_</span> <span class="o">[</span>migration/0<span class="o">]</span>
</span></span><span class="line"><span class="cl">root        <span class="m">11</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        S    05:15   0:00  <span class="se">\_</span> <span class="o">[</span>watchdog/0<span class="o">]</span>
</span></span><span class="line"><span class="cl">root        <span class="m">12</span>  0.0  0.0      <span class="m">0</span>     <span class="m">0</span> ?        S    05:15   0:00  <span class="se">\_</span> <span class="o">[</span>cpuhp/0<span class="o">]</span>
</span></span></code></pre></div><p>Or you can just delete the entire <code>root</code>, a.k.a. nuking the node.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># rm -rf --no-preserve-root /</span>
</span></span></code></pre></div><p>Now if you look at the nodes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get nodes -o wide
</span></span><span class="line"><span class="cl">NAME       STATUS     ROLES     AGE       VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION      CONTAINER-RUNTIME
</span></span><span class="line"><span class="cl">worker-0   Ready      &lt;none&gt;    30m       v1.11.2   192.168.199.20   &lt;none&gt;        Ubuntu 18.04.1 LTS   4.15.0-33-generic   cri-o://1.11.2
</span></span><span class="line"><span class="cl">worker-1   Ready      &lt;none&gt;    29m       v1.11.2   192.168.199.21   &lt;none&gt;        Ubuntu 18.04.1 LTS   4.15.0-33-generic   cri-o://1.11.2
</span></span><span class="line"><span class="cl">worker-2   NotReady   &lt;none&gt;    27m       v1.11.2   192.168.199.22   &lt;none&gt;        Unknown              4.15.0-33-generic   cri-o://Unknown
</span></span></code></pre></div><p>The last node <code>worker-2</code> is in <code>NotReady</code> state. We have successfully made one node unusable. Now that one node is gone your pod will be scheduled on another node, where you can do similar stuff.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods -o wide
</span></span><span class="line"><span class="cl">NAME                   READY     STATUS    RESTARTS   AGE       IP          NODE       NOMINATED NODE
</span></span><span class="line"><span class="cl">web-66cdf67bbc-44zhj   0/1       Unknown   <span class="m">0</span>          20m       10.38.0.1   worker-2   &lt;none&gt;
</span></span><span class="line"><span class="cl">web-66cdf67bbc-b22xn   1/1       Running   <span class="m">0</span>          8m        10.32.0.2   worker-0   &lt;none&gt;
</span></span></code></pre></div><p>As you can see above the pod is re-scheduled on node <code>worker-0</code>. And we can do same set of steps to make <code>worker-0</code> unusable.</p>
<p>Deleting the deployment to cleanup.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl delete deployment web
</span></span><span class="line"><span class="cl">deployment.extensions <span class="s2">&#34;web&#34;</span> deleted
</span></span></code></pre></div><h1 id="stopping-this-attack-using-podsecuritypolicy">Stopping this attack using PodSecurityPolicy<a hidden class="anchor" aria-hidden="true" href="#stopping-this-attack-using-podsecuritypolicy">#</a></h1>
<p>Now as a cluster admin how can you prevent this from happening? You can create something called as <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/"><code>PodSecurityPolicy</code></a>. This let&rsquo;s you define what kind of pods be created. Or what permissions pod can request. Enable admission controller for this, read about it <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#podsecuritypolicy">here</a>.</p>
<p>Here is an example <code>PodSecurityPolicy</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">$ cat podsecuritypolicy.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">policy/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PodSecurityPolicy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">seLinux</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l">RunAsAny</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">supplementalGroups</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l">RunAsAny</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l">RunAsAny</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">fsGroup</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l">RunAsAny</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="s1">&#39;*&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">  </span><span class="c"># Don&#39;t allow privileged pods!</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">allowedHostPaths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">pathPrefix</span><span class="p">:</span><span class="w"> </span><span class="l">/foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span></code></pre></div><p>In above example, we are restricting access to <code>hostPath</code> a pod can request. Here the path that is allowed is <code>/foo</code> and has <code>readOnly</code> access to the underlying file system.</p>
<p>Create <code>PodSecurityPolicy</code> using above file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f podsecuritypolicy.yaml
</span></span><span class="line"><span class="cl">podsecuritypolicy.policy/example created
</span></span></code></pre></div><p>To enable this policy we need to create few more objects, a <code>Role</code> and <code>RoleBinding</code>.</p>
<p><code>Role</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">$ cat role.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorize-hostpath</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;policy&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;podsecuritypolicies&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">     </span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">resourceNames</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="l">example</span><span class="w">
</span></span></span></code></pre></div><p>This <code>Role</code> will allow usage of policy that we created above.</p>
<p>Create <code>Role</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f role.yaml
</span></span><span class="line"><span class="cl">role.rbac.authorization.k8s.io/authorize-hostpath created
</span></span></code></pre></div><p><code>RoleBinding</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">$ cat rolebinding.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">RoleBinding</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">auth-hostpath</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Role</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">authorize-hostpath</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># Authorize all service accounts in a namespace:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Group</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">system:serviceaccounts</span><span class="w">
</span></span></span></code></pre></div><p>This <code>RoleBinding</code> will bind the <code>Role</code> above and all the <code>ServiceAccounts</code> in current namespace.</p>
<p>Create <code>RoleBinding</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl create -f rolebinding.yaml
</span></span><span class="line"><span class="cl">rolebinding.rbac.authorization.k8s.io/auth-hostpath created
</span></span></code></pre></div><p>Now that we have required permissions in place, try to re-create the <code>deployment</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f deployment.yaml
</span></span><span class="line"><span class="cl">deployment.apps/web created
</span></span></code></pre></div><p>The pod is not created and in events you can see an error as <code>Error creating: pods &quot;web-66cdf67bbc-&quot; is forbidden: unable to validate against any pod security policy: [spec.volumes[0].hostPath.pathPrefix: Invalid value: &quot;/&quot;: is not allowed to be used]</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get events
</span></span><span class="line"><span class="cl">LAST SEEN   FIRST SEEN   COUNT     NAME                              KIND         SUBOBJECT   TYPE      REASON                    SOURCE                  MESSAGE
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">6s          17s          <span class="m">12</span>        web-66cdf67bbc.15530e83fd4f8592   ReplicaSet               Warning   FailedCreate              replicaset-controller   Error creating: pods <span class="s2">&#34;web-66cdf67bbc-&#34;</span> is forbidden: unable to validate against any pod security policy: <span class="o">[</span>spec.volumes<span class="o">[</span>0<span class="o">]</span>.hostPath.pathPrefix: Invalid value: <span class="s2">&#34;/&#34;</span>: is not allowed to be used<span class="o">]</span>
</span></span></code></pre></div><p>This error is due to the fact that we have allowed <code>hostPath</code> to be only under <code>/foo</code> and in the original file it is set to <code>/</code>.</p>
<p>Now change in <code>deployment.yaml</code> file at path <code>deployment.spec.template.spec.volumes[0].hostPath.path</code> from <code>/</code> to <code>/foo</code> and apply again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f deployment.yaml
</span></span><span class="line"><span class="cl">deployment.apps/web configured
</span></span></code></pre></div><p>You can see another error <code>Error creating: pods &quot;web-85cb548b47-&quot; is forbidden: unable to validate against any pod security policy: [spec.containers[0].volumeMounts[0].readOnly: Invalid value: false: must be read-only]</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get events
</span></span><span class="line"><span class="cl">LAST SEEN   FIRST SEEN   COUNT     NAME                              KIND         SUBOBJECT   TYPE      REASON                    SOURCE                  MESSAGE
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">5s          15s          <span class="m">12</span>        web-85cb548b47.15530eb0c27c6122   ReplicaSet               Warning   FailedCreate              replicaset-controller   Error creating: pods <span class="s2">&#34;web-85cb548b47-&#34;</span> is forbidden: unable to validate against any pod security policy: <span class="o">[</span>spec.containers<span class="o">[</span>0<span class="o">]</span>.volumeMounts<span class="o">[</span>0<span class="o">]</span>.readOnly: Invalid value: false: must be read-only<span class="o">]</span>
</span></span></code></pre></div><p>This is because in the <code>volumeMount</code>&rsquo;s <code>readOnly</code> we have used in container has no value defined, which means it defaults to <code>false</code> and in <code>PodSecurityPolicy</code> we have defaulted the <code>hostPath</code> to be <code>readOnly</code>.</p>
<p>So change <code>deployment.spec.template.spec.containers[0].volumeMounts[0].readOnly</code> to <code>true</code>. And manifest should look like following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">$ cat deployment.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">centos/httpd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/foo</span><span class="w">
</span></span></span></code></pre></div><p>Now if you re-deploy the app:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f deployment.yaml
</span></span><span class="line"><span class="cl">deployment.apps/web configured
</span></span></code></pre></div><p>The pod is scheduled and created:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods
</span></span><span class="line"><span class="cl">NAME                   READY     STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">web-7b77459d6b-kbqm8   1/1       Running   <span class="m">0</span>          7s
</span></span></code></pre></div><p>Now if you exec into this pod and try to do something, you can see nothing happens:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl <span class="nb">exec</span> -it web-7b77459d6b-kbqm8 bash
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@web-7b77459d6b-kbqm8 /<span class="o">]</span><span class="c1"># cd /web/</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@web-7b77459d6b-kbqm8 web<span class="o">]</span><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@web-7b77459d6b-kbqm8 web<span class="o">]</span><span class="c1"># touch file.txt</span>
</span></span><span class="line"><span class="cl">touch: cannot touch <span class="s1">&#39;file.txt&#39;</span>: Read-only file system
</span></span></code></pre></div><p>So this is really good feature you can use to stop someone from nuking your cluster.</p>
<h1 id="stopping-this-attack-using-selinux">Stopping this attack using SELinux<a hidden class="anchor" aria-hidden="true" href="#stopping-this-attack-using-selinux">#</a></h1>
<p>Above setup of the Kubernetes cluster had a Ubuntu based machines, now I have a Kubernetes cluster that is setup on Fedora which supports <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/5/html/deployment_guide/ch-selinux">SELinux</a>.</p>
<p>You can setup this cluster following steps in this <a href="https://suraj.io/post/single-node-k8s-fedora-selinux/">post</a>.</p>
<p><strong>Note</strong>: This is a simple cluster setup without <code>PodSecurityPolicy</code>.</p>
<p>Once you have the cluster running:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get nodes -o wide
</span></span><span class="line"><span class="cl">NAME      STATUS    ROLES     AGE       VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                    KERNEL-VERSION           CONTAINER-RUNTIME
</span></span><span class="line"><span class="cl">fedora    Ready     master    23m       v1.11.2   10.0.2.15     &lt;none&gt;        Fedora <span class="m">28</span> <span class="o">(</span>Cloud Edition<span class="o">)</span>   4.16.3-301.fc28.x86_64   docker://1.13.1
</span></span></code></pre></div><p>Lets follow the same set of steps of creating the deployment:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl apply -f deployment.yaml
</span></span><span class="line"><span class="cl">deployment.apps/web created
</span></span></code></pre></div><p>The pod is created:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl get pods
</span></span><span class="line"><span class="cl">NAME                   READY     STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">web-66cdf67bbc-t9n7m   1/1       Running   <span class="m">0</span>          28s
</span></span></code></pre></div><p>Getting into the machine:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl <span class="nb">exec</span> -it web-66cdf67bbc-t9n7m bash
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@web-66cdf67bbc-t9n7m /<span class="o">]</span><span class="c1">#</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@web-66cdf67bbc-t9n7m /<span class="o">]</span><span class="c1"># cd /web/</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@web-66cdf67bbc-t9n7m web<span class="o">]</span><span class="c1"># ls</span>
</span></span><span class="line"><span class="cl">bin  boot  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  vagrant  var
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@web-66cdf67bbc-t9n7m web<span class="o">]</span><span class="c1"># touch file.txt</span>
</span></span><span class="line"><span class="cl">touch: cannot touch <span class="s1">&#39;file.txt&#39;</span>: Permission denied
</span></span></code></pre></div><p>As you can see if you go to the root of host which is mounted at <code>/web</code> and try to create new file, it fails. This event will be logged into the SELinux audit logs. On host if you run following you will see logs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># ausearch -m avc</span>
</span></span><span class="line"><span class="cl">----
</span></span><span class="line"><span class="cl">time-&gt;Tue Sep <span class="m">11</span> 06:41:54 <span class="m">2018</span>
</span></span><span class="line"><span class="cl"><span class="nv">type</span><span class="o">=</span>AVC <span class="nv">msg</span><span class="o">=</span>audit<span class="o">(</span>1536648114.522:985<span class="o">)</span>: avc:  denied  <span class="o">{</span> write <span class="o">}</span> <span class="k">for</span>  <span class="nv">pid</span><span class="o">=</span><span class="m">15775</span> <span class="nv">comm</span><span class="o">=</span><span class="s2">&#34;touch&#34;</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&#34;/&#34;</span> <span class="nv">dev</span><span class="o">=</span><span class="s2">&#34;sda1&#34;</span> <span class="nv">ino</span><span class="o">=</span><span class="m">2</span> <span class="nv">scontext</span><span class="o">=</span>system_u:system_r:container_t:s0:c230,c784 <span class="nv">tcontext</span><span class="o">=</span>system_u:object_r:root_t:s0 <span class="nv">tclass</span><span class="o">=</span>dir <span class="nv">permissive</span><span class="o">=</span><span class="m">0</span>
</span></span></code></pre></div><p>Here simple SELinux has stopped the container from writing into places it shouldn&rsquo;t. Compared to <code>PodSecurityPolicy</code> (which is a beta feature in k8s 1.11), SELinux can help you right away if you are using older Kubernetes cluster and are on CentOS or RHEL.</p>
<h1 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h1>
<ul>
<li><a href="https://github.com/kinvolk/kubernetes-the-hard-way-vagrant">Multi node Kubernetes setup used here</a></li>
<li><a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">Pod Security Policies</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/securing-a-cluster/#controlling-what-privileges-containers-run-with">Securing a Cluster</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/volumes/#hostpath">hostPath volumes</a></li>
<li><a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#podsecuritypolicy">Enabling Admission controller</a></li>
<li><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/security-enhanced_linux/sect-security-enhanced_linux-fixing_problems-searching_for_and_viewing_denials">SELinux denials</a></li>
<li><a href="https://suraj.io/post/single-node-k8s-fedora-selinux/">Single node cluster with SELinux used here</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://suraj.io/tags/kubernetes/">Kubernetes</a></li>
      <li><a href="https://suraj.io/tags/openshift/">Openshift</a></li>
      <li><a href="https://suraj.io/tags/hostpath/">Hostpath</a></li>
      <li><a href="https://suraj.io/tags/security/">Security</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://suraj.io/post/single-node-k8s-fedora-selinux/">
    <span class="title">« Prev</span>
    <br>
    <span>Single node Kubernetes Cluster on Fedora with SELinux enabled</span>
  </a>
  <a class="next" href="https://suraj.io/post/mkcert-using-python-http-server/">
    <span class="title">Next »</span>
    <br>
    <span>HTTPS during development using &#39;mkcert&#39;</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HostPath volumes and it&#39;s problems on x"
            href="https://x.com/intent/tweet/?text=HostPath%20volumes%20and%20it%27s%20problems&amp;url=https%3a%2f%2fsuraj.io%2fpost%2fk8s-hostpat-nuke-nodes%2f&amp;hashtags=kubernetes%2copenshift%2chostpath%2csecurity">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HostPath volumes and it&#39;s problems on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsuraj.io%2fpost%2fk8s-hostpat-nuke-nodes%2f&amp;title=HostPath%20volumes%20and%20it%27s%20problems&amp;summary=HostPath%20volumes%20and%20it%27s%20problems&amp;source=https%3a%2f%2fsuraj.io%2fpost%2fk8s-hostpat-nuke-nodes%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HostPath volumes and it&#39;s problems on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fsuraj.io%2fpost%2fk8s-hostpat-nuke-nodes%2f&title=HostPath%20volumes%20and%20it%27s%20problems">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HostPath volumes and it&#39;s problems on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsuraj.io%2fpost%2fk8s-hostpat-nuke-nodes%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HostPath volumes and it&#39;s problems on whatsapp"
            href="https://api.whatsapp.com/send?text=HostPath%20volumes%20and%20it%27s%20problems%20-%20https%3a%2f%2fsuraj.io%2fpost%2fk8s-hostpat-nuke-nodes%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HostPath volumes and it&#39;s problems on telegram"
            href="https://telegram.me/share/url?text=HostPath%20volumes%20and%20it%27s%20problems&amp;url=https%3a%2f%2fsuraj.io%2fpost%2fk8s-hostpat-nuke-nodes%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share HostPath volumes and it&#39;s problems on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=HostPath%20volumes%20and%20it%27s%20problems&u=https%3a%2f%2fsuraj.io%2fpost%2fk8s-hostpat-nuke-nodes%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://suraj.io/">Suraj Deshmukh</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
