<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>How to gracefully kill Kubernetes Jobs with a sidecar? | Suraj Deshmukh</title>
<meta name="keywords" content="kubernetes, configuration, notes">
<meta name="description" content="A sidecar in a Kubernetes Job, what? Yeah you might need one and here is how to shut it.">
<meta name="author" content="Suraj Deshmukh">
<link rel="canonical" href="https://suraj.io/post/how-to-gracefully-kill-kubernetes-jobs-with-a-sidecar/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://suraj.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://suraj.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://suraj.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://suraj.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://suraj.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://suraj.io/post/how-to-gracefully-kill-kubernetes-jobs-with-a-sidecar/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-97006720-1', 'auto');
	
	ga('send', 'pageview');
}
</script><meta property="og:title" content="How to gracefully kill Kubernetes Jobs with a sidecar?" />
<meta property="og:description" content="A sidecar in a Kubernetes Job, what? Yeah you might need one and here is how to shut it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://suraj.io/post/how-to-gracefully-kill-kubernetes-jobs-with-a-sidecar/" />
<meta property="og:image" content="https://suraj.io/images/papermod-cover.png" />
<meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-08-29T15:33:51+05:30" />
<meta property="article:modified_time" content="2020-08-29T15:33:51+05:30" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://suraj.io/images/papermod-cover.png" />
<meta name="twitter:title" content="How to gracefully kill Kubernetes Jobs with a sidecar?"/>
<meta name="twitter:description" content="A sidecar in a Kubernetes Job, what? Yeah you might need one and here is how to shut it."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://suraj.io/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "How to gracefully kill Kubernetes Jobs with a sidecar?",
      "item": "https://suraj.io/post/how-to-gracefully-kill-kubernetes-jobs-with-a-sidecar/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "How to gracefully kill Kubernetes Jobs with a sidecar?",
  "name": "How to gracefully kill Kubernetes Jobs with a sidecar?",
  "description": "A sidecar in a Kubernetes Job, what? Yeah you might need one and here is how to shut it.",
  "keywords": [
    "kubernetes", "configuration", "notes"
  ],
  "articleBody": "Have you ever had a sidecar in your Kubernetes Job? If no, then trust me that you are lucky. If yes, then you will have the frustration of your life. The thing is Kubernetes Jobs are meant to exit on completion. But if you have a long-running sidecar, then that might twist things for Kubernetes and in turn of you.\nWhy would you even want a sidecar for Job? Well, one of the most prevalent use case is when using service mesh proxy. There could be something else as well like metrics endpoint, log collection or whatever. Given the complexity and heterogeneity of the workloads, there could be any kind of use case that involves having sidecar for a Job pod.\nThis blog post will showcase how to cleanly exit from a Job pod if you have a long-running sidecar.\nNormal Job Let’s see how a normal Job workflow looks like. I have a Job that runs the following script:\n#!/bin/bash for num in $(seq 10 -1 1); do echo $num sleep 1 done echo \"And it is a lift off!\" See the above script in the Github repository here.\nAnd the Kubernetes Job configuration looks like this:\napiVersion: batch/v1 kind: Job metadata: name: foojob namespace: default spec: template: spec: restartPolicy: OnFailure containers: - name: foojob image: fedora:32 command: [\"/bin/bash\"] args: [\"/scripts-dir/run.sh\"] volumeMounts: - name: scripts-vol mountPath: /scripts-dir volumes: - name: scripts-vol configMap: name: scripts-configmap See the full definition of the Job configuration here. To understand why the Job configuration has volumes and volumeMounts, read my other blog where I explain how configmaps are the best way to use inject scripts into containers.\nA typical run of above will look like this:\n$ helm install --generate-name job/ NAME: job-1598685079 LAST DEPLOYED: Sat Aug 29 12:41:19 2020 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None $ kubectl get pods NAME READY STATUS RESTARTS AGE foojob-86rlf 0/1 ContainerCreating 0 1s $ kubectl logs foojob-86rlf 10 9 8 7 6 5 4 3 2 1 And it is a lift off! $ kubectl get pods NAME READY STATUS RESTARTS AGE foojob-86rlf 0/1 Completed 0 14s So pod exits with STATUS field set to Completed.\nWhat happens when a Job has Sidecar? To add a sidecar to our existing Job I added a container which just sleeps forever. See following diff to understand what has changed:\ndiff --git job/templates/job.yaml job/templates/job.yaml index 04e7175..1bb5a08 100644 --- job/templates/job.yaml +++ job/templates/job.yaml @@ -9,6 +9,10 @@ spec: spec: restartPolicy: OnFailure containers: + - name: endlesssidecar + image: fedora:32 + command: [\"/bin/bash\"] + args: [\"-c\", \"sleep infinity; echo 'stopping now!'\"] - name: foojob image: fedora:32 command: [\"/bin/bash\"] See the new full configuration of Job manifest here.\nNOTE: In your case, it could be any other sidecar, for illustration purposes I have added a dummy sidecar.\nNow let’s see the full run of this setup:\n$ helm install --generate-name job/ NAME: job-1598685624 LAST DEPLOYED: Sat Aug 29 12:50:25 2020 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None $ kubectl get pods NAME READY STATUS RESTARTS AGE foojob-kd9sl 0/2 ContainerCreating 0 1s $ kubectl logs foojob-kd9sl foojob 10 9 8 7 6 5 4 3 2 1 And it is a lift off! $ kubectl get pods NAME READY STATUS RESTARTS AGE foojob-kd9sl 1/2 NotReady 0 21s If you see everything went fine in the foojob container of the Job pod. But the pod STATUS has changed to NotReady. This is because one container has stopped successfully, and the other is still running. This is the problem with sidecar in the Job. Now Kubernetes does not concede this as Completed because not all containers have stopped in the pod.\nJob Sidecar with unique setup! Since the long running sidecar does not stop gracefully, we should make sure that it is halted. So the onus is on the foojob to kill the long running sidecar. So this is what I have added to our simple script:\ndiff --git job/scripts/run.sh job/scripts/run.sh index 8fed959..5932149 100755 --- job/scripts/run.sh +++ job/scripts/run.sh @@ -6,3 +6,6 @@ for num in $(seq 10 -1 1); do done echo \"And it is a lift off!\" + +pkill sleep +true But have you realised how does a script running in one container has access to the process in another container? Well, we have a Kubernetes native answer to that: shareProcessNamespace. Here is what it mean straight from the docs:\nShare a single process namespace between all of the containers in a pod. When this is set containers will be able to view and signal processes from other containers in the same pod, and the first process in each container will not be assigned PID 1. HostPID and ShareProcessNamespace cannot both be set.\nIn simple terms set the field shareProcessNamespace to true in pod.spec and all containers now share the process namespace and can see each other. Due to this enablement pkill sleep from the foojob container can kill its sidecar or sidecar’s main process.\nHere is the diff from the Job YAML file:\ndiff --git job/templates/job.yaml job/templates/job.yaml index 1bb5a08..61d75cf 100644 --- job/templates/job.yaml +++ job/templates/job.yaml @@ -7,14 +7,15 @@ metadata: spec: template: spec: + shareProcessNamespace: true restartPolicy: OnFailure containers: command: [\"/bin/bash\"] - name: foojob - image: fedora:32 + image: surajd/fedora32-pgrep command: [\"/bin/bash\"] args: [\"/scripts-dir/run.sh\"] volumeMounts: The image has been changed from plain fedora:32 to surajd/fedora32-pgrep because the default fedora image does not ship pkill so I installed the package procps and now all the “process-killing” tools are available in the new docker image. See the dockerfile here.\nNow let’s see this in operation:\n$ helm install --generate-name job/ NAME: job-1598689001 LAST DEPLOYED: Sat Aug 29 13:46:41 2020 NAMESPACE: default STATUS: deployed REVISION: 1 TEST SUITE: None $ kubectl get pods NAME READY STATUS RESTARTS AGE foojob-wr9hl 0/2 ContainerCreating 0 1s $ kubectl logs foojob-wr9hl foojob 10 9 8 7 6 5 4 3 2 1 And it is a lift off! $ kubectl logs foojob-wr9hl endlesssidecar Terminated stopping now! $ kubectl get pods NAME READY STATUS RESTARTS AGE foojob-wr9hl 0/2 Completed 0 32s If you notice there is output from the sidecar as well, it first says Terminated which is as a result of the pkill we added. So that is the easiest way to kill the sidecar and satisfy Kubernetes.\nUpstream efforts There is an issue in Kubernetes upstream for this, find it here. A KEP is present here. And this blog is very much inspired by this comment. Conclusion We will just have to wait until we have the upstream with better support to segregate sidecar from primary containers in the pod. So until then, this hack is all we’ve got. You can find all the configuration used in this blog here.\n",
  "wordCount" : "1113",
  "inLanguage": "en",
  "image": "https://suraj.io/images/papermod-cover.png","datePublished": "2020-08-29T15:33:51+05:30",
  "dateModified": "2020-08-29T15:33:51+05:30",
  "author":{
    "@type": "Person",
    "name": "Suraj Deshmukh"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://suraj.io/post/how-to-gracefully-kill-kubernetes-jobs-with-a-sidecar/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Suraj Deshmukh",
    "logo": {
      "@type": "ImageObject",
      "url": "https://suraj.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://suraj.io/" accesskey="h" title="Suraj Deshmukh (Alt + H)">Suraj Deshmukh</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://suraj.io/post" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/about" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/archives" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/search" title="Search 🔍">
                    <span>Search 🔍</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="https://suraj.io/series" title="Series">
                    <span>Series</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://suraj.io/">Home</a>&nbsp;»&nbsp;<a href="https://suraj.io/post/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      How to gracefully kill Kubernetes Jobs with a sidecar?
    </h1>
    <div class="post-description">
      A sidecar in a Kubernetes Job, what? Yeah you might need one and here is how to shut it.
    </div>
    <div class="post-meta"><span title='2020-08-29 15:33:51 +0530 +0530'>August 29, 2020</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Suraj Deshmukh&nbsp;|&nbsp;<a href="https://github.com/surajssd/blog_contents/blob/master/content/post/how-to-gracefully-kill-kubernetes-jobs-with-a-sidecar.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#normal-job" aria-label="Normal Job">Normal Job</a></li>
                <li>
                    <a href="#what-happens-when-a-job-has-sidecar" aria-label="What happens when a Job has Sidecar?">What happens when a Job has Sidecar?</a></li>
                <li>
                    <a href="#job-sidecar-with-unique-setup" aria-label="Job Sidecar with unique setup!">Job Sidecar with unique setup!</a></li>
                <li>
                    <a href="#upstream-efforts" aria-label="Upstream efforts">Upstream efforts</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Have you ever had a sidecar in your Kubernetes Job? If no, then trust me that you are lucky. If yes, then you will have the frustration of your life. The thing is Kubernetes Jobs are meant to exit on completion. But if you have a long-running sidecar, then that might twist things for Kubernetes and in turn of you.</p>
<p>Why would you even want a sidecar for Job? Well, one of the most prevalent use case is when using service mesh proxy. There could be something else as well like metrics endpoint, log collection or whatever. Given the complexity and heterogeneity of the workloads, there could be any kind of use case that involves having sidecar for a Job pod.</p>
<p>This blog post will showcase how to cleanly exit from a Job pod if you have a long-running sidecar.</p>
<h2 id="normal-job">Normal Job<a hidden class="anchor" aria-hidden="true" href="#normal-job">#</a></h2>
<p>Let&rsquo;s see how a normal Job workflow looks like. I have a Job that runs the following script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> num in <span class="k">$(</span>seq <span class="m">10</span> -1 1<span class="k">)</span><span class="p">;</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="nb">echo</span> <span class="nv">$num</span>
</span></span><span class="line"><span class="cl">  sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">done</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;And it is a lift off!&#34;</span>
</span></span></code></pre></div><p>See the above script in the Github repository <a href="https://github.com/surajssd/kill-jobpod-with-sidecar/blob/5cff292a822c56bb9c2930e4f0e82e16b1a31340/job/scripts/run.sh">here</a>.</p>
<p>And the Kubernetes Job configuration looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foojob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foojob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">fedora:32</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/bash&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/scripts-dir/run.sh&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">scripts-vol</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/scripts-dir</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">scripts-vol</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">scripts-configmap</span><span class="w">
</span></span></span></code></pre></div><p>See the full definition of the Job configuration <a href="https://github.com/surajssd/kill-jobpod-with-sidecar/blob/5cff292a822c56bb9c2930e4f0e82e16b1a31340/job/templates/deployment.yaml">here</a>. To understand why the Job configuration has <code>volumes</code> and <code>volumeMounts</code>, read <a href="https://suraj.io/post/use-configmap-for-scripts/">my other blog</a> where I explain how configmaps are the best way to use inject scripts into containers.</p>
<p>A typical run of above will look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ helm install --generate-name job/
</span></span><span class="line"><span class="cl">NAME: job-1598685079
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Sat Aug <span class="m">29</span> 12:41:19 <span class="m">2020</span>
</span></span><span class="line"><span class="cl">NAMESPACE: default
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pods
</span></span><span class="line"><span class="cl">NAME           READY   STATUS              RESTARTS   AGE
</span></span><span class="line"><span class="cl">foojob-86rlf   0/1     ContainerCreating   <span class="m">0</span>          1s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl logs foojob-86rlf
</span></span><span class="line"><span class="cl"><span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl">And it is a lift off!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pods
</span></span><span class="line"><span class="cl">NAME           READY   STATUS      RESTARTS   AGE
</span></span><span class="line"><span class="cl">foojob-86rlf   0/1     Completed   <span class="m">0</span>          14s
</span></span></code></pre></div><p>So pod exits with <code>STATUS</code> field set to <code>Completed</code>.</p>
<h2 id="what-happens-when-a-job-has-sidecar">What happens when a Job has Sidecar?<a hidden class="anchor" aria-hidden="true" href="#what-happens-when-a-job-has-sidecar">#</a></h2>
<p>To add a sidecar to our existing Job I added a container which just sleeps forever. See following diff to understand what has changed:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git job/templates/job.yaml job/templates/job.yaml
</span></span></span><span class="line"><span class="cl"><span class="gh">index 04e7175..1bb5a08 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- job/templates/job.yaml
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ job/templates/job.yaml
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -9,6 +9,10 @@ spec:
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>     spec:
</span></span><span class="line"><span class="cl">       restartPolicy: OnFailure
</span></span><span class="line"><span class="cl">       containers:
</span></span><span class="line"><span class="cl"><span class="gi">+      - name: endlesssidecar
</span></span></span><span class="line"><span class="cl"><span class="gi">+        image: fedora:32
</span></span></span><span class="line"><span class="cl"><span class="gi">+        command: [&#34;/bin/bash&#34;]
</span></span></span><span class="line"><span class="cl"><span class="gi">+        args: [&#34;-c&#34;, &#34;sleep infinity; echo &#39;stopping now!&#39;&#34;]
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>       - name: foojob
</span></span><span class="line"><span class="cl">         image: fedora:32
</span></span><span class="line"><span class="cl">         command: [&#34;/bin/bash&#34;]
</span></span></code></pre></div><p>See the new full configuration of Job manifest <a href="https://github.com/surajssd/kill-jobpod-with-sidecar/blob/80dd2e8d485c62f62ff1de67d6c5128c07c6fba0/job/templates/deployment.yaml#L12-L15">here</a>.</p>
<blockquote>
<p><strong>NOTE:</strong> In your case, it could be any other sidecar, for illustration purposes I have added a dummy sidecar.</p>
</blockquote>
<p>Now let&rsquo;s see the full run of this setup:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ helm install --generate-name job/
</span></span><span class="line"><span class="cl">NAME: job-1598685624
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Sat Aug <span class="m">29</span> 12:50:25 <span class="m">2020</span>
</span></span><span class="line"><span class="cl">NAMESPACE: default
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pods
</span></span><span class="line"><span class="cl">NAME           READY   STATUS              RESTARTS   AGE
</span></span><span class="line"><span class="cl">foojob-kd9sl   0/2     ContainerCreating   <span class="m">0</span>          1s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl logs foojob-kd9sl foojob
</span></span><span class="line"><span class="cl"><span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl">And it is a lift off!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pods
</span></span><span class="line"><span class="cl">NAME           READY   STATUS     RESTARTS   AGE
</span></span><span class="line"><span class="cl">foojob-kd9sl   1/2     NotReady   <span class="m">0</span>          21s
</span></span></code></pre></div><p>If you see everything went fine in the <code>foojob</code> container of the Job pod. But the pod <code>STATUS</code> has changed to <code>NotReady</code>. This is because one container has stopped successfully, and the other is still running. This is the problem with sidecar in the Job. Now Kubernetes does not concede this as <code>Completed</code> because not all containers have stopped in the pod.</p>
<h2 id="job-sidecar-with-unique-setup">Job Sidecar with unique setup!<a hidden class="anchor" aria-hidden="true" href="#job-sidecar-with-unique-setup">#</a></h2>
<p>Since the long running sidecar does not stop gracefully, we should make sure that it is halted. So the onus is on the <code>foojob</code> to kill the long running sidecar. So this is what I have added to our simple script:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git job/scripts/run.sh job/scripts/run.sh
</span></span></span><span class="line"><span class="cl"><span class="gh">index 8fed959..5932149 100755
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- job/scripts/run.sh
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ job/scripts/run.sh
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -6,3 +6,6 @@ for num in $(seq 10 -1 1); do
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> done
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> echo &#34;And it is a lift off!&#34;
</span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+pkill sleep
</span></span></span><span class="line"><span class="cl"><span class="gi">+true
</span></span></span></code></pre></div><p>But have you realised how does a script running in one container has access to the process in another container? Well, we have a Kubernetes native answer to that: <code>shareProcessNamespace</code>. Here is what it mean straight from the docs:</p>
<blockquote>
<p><code>Share a single process namespace between all of the containers in a pod. When this is set containers will be able to view and signal processes from other containers in the same pod, and the first process in each container will not be assigned PID 1. HostPID and ShareProcessNamespace cannot both be set.</code></p>
</blockquote>
<p>In simple terms set the field <code>shareProcessNamespace</code> to <code>true</code> in <code>pod.spec</code> and all containers now share the process namespace and can see each other. Due to this enablement <code>pkill sleep</code> from the <code>foojob</code> container can kill its sidecar or sidecar&rsquo;s main process.</p>
<p>Here is the diff from the Job YAML file:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git job/templates/job.yaml job/templates/job.yaml
</span></span></span><span class="line"><span class="cl"><span class="gh">index 1bb5a08..61d75cf 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- job/templates/job.yaml
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ job/templates/job.yaml
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -7,14 +7,15 @@ metadata:
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> spec:
</span></span><span class="line"><span class="cl">   template:
</span></span><span class="line"><span class="cl">     spec:
</span></span><span class="line"><span class="cl"><span class="gi">+      shareProcessNamespace: true
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>       restartPolicy: OnFailure
</span></span><span class="line"><span class="cl">       containers:
</span></span><span class="line"><span class="cl">         command: [&#34;/bin/bash&#34;]
</span></span><span class="line"><span class="cl">       - name: foojob
</span></span><span class="line"><span class="cl"><span class="gd">-        image: fedora:32
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+        image: surajd/fedora32-pgrep
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>         command: [&#34;/bin/bash&#34;]
</span></span><span class="line"><span class="cl">         args: [&#34;/scripts-dir/run.sh&#34;]
</span></span><span class="line"><span class="cl">         volumeMounts:
</span></span></code></pre></div><p>The image has been changed from plain <code>fedora:32</code> to <code>surajd/fedora32-pgrep</code> because the default fedora image does not ship <code>pkill</code> so I installed the package <code>procps</code> and now all the &ldquo;process-killing&rdquo; tools are available in the new docker image. See the dockerfile <a href="https://github.com/surajssd/kill-jobpod-with-sidecar/blob/master/Dockerfile">here</a>.</p>
<p>Now let&rsquo;s see this in operation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ helm install --generate-name job/
</span></span><span class="line"><span class="cl">NAME: job-1598689001
</span></span><span class="line"><span class="cl">LAST DEPLOYED: Sat Aug <span class="m">29</span> 13:46:41 <span class="m">2020</span>
</span></span><span class="line"><span class="cl">NAMESPACE: default
</span></span><span class="line"><span class="cl">STATUS: deployed
</span></span><span class="line"><span class="cl">REVISION: <span class="m">1</span>
</span></span><span class="line"><span class="cl">TEST SUITE: None
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pods
</span></span><span class="line"><span class="cl">NAME           READY   STATUS              RESTARTS   AGE
</span></span><span class="line"><span class="cl">foojob-wr9hl   0/2     ContainerCreating   <span class="m">0</span>          1s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl logs foojob-wr9hl foojob
</span></span><span class="line"><span class="cl"><span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="m">9</span>
</span></span><span class="line"><span class="cl"><span class="m">8</span>
</span></span><span class="line"><span class="cl"><span class="m">7</span>
</span></span><span class="line"><span class="cl"><span class="m">6</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span>
</span></span><span class="line"><span class="cl"><span class="m">4</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="m">1</span>
</span></span><span class="line"><span class="cl">And it is a lift off!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl logs foojob-wr9hl endlesssidecar
</span></span><span class="line"><span class="cl">Terminated
</span></span><span class="line"><span class="cl">stopping now!
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ kubectl get pods
</span></span><span class="line"><span class="cl">NAME           READY   STATUS      RESTARTS   AGE
</span></span><span class="line"><span class="cl">foojob-wr9hl   0/2     Completed   <span class="m">0</span>          32s
</span></span></code></pre></div><p>If you notice there is output from the sidecar as well, it first says <code>Terminated</code> which is as a result of the <code>pkill</code> we added. So that is the easiest way to kill the sidecar and satisfy Kubernetes.</p>
<h2 id="upstream-efforts">Upstream efforts<a hidden class="anchor" aria-hidden="true" href="#upstream-efforts">#</a></h2>
<ul>
<li>There is an issue in Kubernetes upstream for this, find it <a href="https://github.com/kubernetes/kubernetes/issues/25908">here</a>.</li>
<li>A KEP is present <a href="https://github.com/kubernetes/enhancements/issues/753">here</a>.</li>
<li>And this blog is very much inspired by this <a href="https://github.com/linkerd/linkerd2/issues/1869#issuecomment-595456178">comment</a>.</li>
</ul>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>We will just have to wait until we have the upstream with better support to segregate sidecar from primary containers in the pod. So until then, this hack is all we&rsquo;ve got. You can find all the configuration used in this blog <a href="https://github.com/surajssd/kill-jobpod-with-sidecar">here</a>.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://suraj.io/tags/kubernetes/">Kubernetes</a></li>
      <li><a href="https://suraj.io/tags/configuration/">Configuration</a></li>
      <li><a href="https://suraj.io/tags/notes/">Notes</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://suraj.io/post/book-review-algorithms-to-live-by-the-computer-science-of-human-decisions/">
    <span class="title">« Prev</span>
    <br>
    <span>Book Review: Algorithms to Live by — The Computer Science of Human Decisions</span>
  </a>
  <a class="next" href="https://suraj.io/post/use-configmap-for-scripts/">
    <span class="title">Next »</span>
    <br>
    <span>Use Configmap for Scripts</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share How to gracefully kill Kubernetes Jobs with a sidecar? on x"
            href="https://x.com/intent/tweet/?text=How%20to%20gracefully%20kill%20Kubernetes%20Jobs%20with%20a%20sidecar%3f&amp;url=https%3a%2f%2fsuraj.io%2fpost%2fhow-to-gracefully-kill-kubernetes-jobs-with-a-sidecar%2f&amp;hashtags=kubernetes%2cconfiguration%2cnotes">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share How to gracefully kill Kubernetes Jobs with a sidecar? on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fsuraj.io%2fpost%2fhow-to-gracefully-kill-kubernetes-jobs-with-a-sidecar%2f&amp;title=How%20to%20gracefully%20kill%20Kubernetes%20Jobs%20with%20a%20sidecar%3f&amp;summary=How%20to%20gracefully%20kill%20Kubernetes%20Jobs%20with%20a%20sidecar%3f&amp;source=https%3a%2f%2fsuraj.io%2fpost%2fhow-to-gracefully-kill-kubernetes-jobs-with-a-sidecar%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share How to gracefully kill Kubernetes Jobs with a sidecar? on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fsuraj.io%2fpost%2fhow-to-gracefully-kill-kubernetes-jobs-with-a-sidecar%2f&title=How%20to%20gracefully%20kill%20Kubernetes%20Jobs%20with%20a%20sidecar%3f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share How to gracefully kill Kubernetes Jobs with a sidecar? on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fsuraj.io%2fpost%2fhow-to-gracefully-kill-kubernetes-jobs-with-a-sidecar%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share How to gracefully kill Kubernetes Jobs with a sidecar? on whatsapp"
            href="https://api.whatsapp.com/send?text=How%20to%20gracefully%20kill%20Kubernetes%20Jobs%20with%20a%20sidecar%3f%20-%20https%3a%2f%2fsuraj.io%2fpost%2fhow-to-gracefully-kill-kubernetes-jobs-with-a-sidecar%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share How to gracefully kill Kubernetes Jobs with a sidecar? on telegram"
            href="https://telegram.me/share/url?text=How%20to%20gracefully%20kill%20Kubernetes%20Jobs%20with%20a%20sidecar%3f&amp;url=https%3a%2f%2fsuraj.io%2fpost%2fhow-to-gracefully-kill-kubernetes-jobs-with-a-sidecar%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share How to gracefully kill Kubernetes Jobs with a sidecar? on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=How%20to%20gracefully%20kill%20Kubernetes%20Jobs%20with%20a%20sidecar%3f&u=https%3a%2f%2fsuraj.io%2fpost%2fhow-to-gracefully-kill-kubernetes-jobs-with-a-sidecar%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer><div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "suraj-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://suraj.io/">Suraj Deshmukh</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
