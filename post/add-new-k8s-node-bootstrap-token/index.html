<!DOCTYPE HTML>

<html>
    <head>
        
            
                <title>Add new Node to k8s cluster with Bootstrap token</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.69.0" />
        


        
            <meta name="author" content="Suraj Deshmukh">
        
        
            <meta name="description" content="Use this technique to add new node to the cluster without providing any certificates and without having to restart the kube-apiserver">
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Add new Node to k8s cluster with Bootstrap token"/>
<meta name="twitter:description" content="Use this technique to add new node to the cluster without providing any certificates and without having to restart the kube-apiserver"/>
<meta name="twitter:site" content="@surajd_"/>

        <meta property="og:title" content="Add new Node to k8s cluster with Bootstrap token" />
<meta property="og:description" content="Use this technique to add new node to the cluster without providing any certificates and without having to restart the kube-apiserver" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://suraj.io/post/add-new-k8s-node-bootstrap-token/" />
<meta property="article:published_time" content="2018-10-24T01:00:51+05:30" />
<meta property="article:modified_time" content="2018-10-24T01:00:51+05:30" />

        <meta itemprop="name" content="Add new Node to k8s cluster with Bootstrap token">
<meta itemprop="description" content="Use this technique to add new node to the cluster without providing any certificates and without having to restart the kube-apiserver">
<meta itemprop="datePublished" content="2018-10-24T01:00:51&#43;05:30" />
<meta itemprop="dateModified" content="2018-10-24T01:00:51&#43;05:30" />
<meta itemprop="wordCount" content="742">



<meta itemprop="keywords" content="kubernetes,security," />
        

        

        
        
            
        

        
        
            <link rel="stylesheet" href="/css/google-font.css" />
            <link rel="stylesheet" href="/css/font-awesome.min.css" />
            <link rel="stylesheet" href="/css/main.css" />
            <link rel="stylesheet" href="/css/add-on.css" />
            <link rel="stylesheet" href="/css/monokai-sublime.css">
        

        

        
        
        
            
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-97006720-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

        
    </head>
    <body>

        
        <div id="wrapper">

    
    
<header id="header">
    
        <h2><a href="/">Suraj Deshmukh</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/post">
                        
                            <i class="fa fa-newspaper-o">&nbsp;</i>Blog
                    </a>
                </li>
            
                <li>
                    <a href="/categories">
                        Categories
                    </a>
                </li>
            
                <li>
                    <a href="/about">
                        About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:https://suraj.io/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:https://suraj.io/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/post">
                            <h3>
                                
                                    <i class="fa fa-newspaper-o">&nbsp;</i>
                                
                                Blog
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/categories">
                            <h3>
                                
                                Categories
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about">
                            <h3>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="https://suraj.io/post/seccomp-in-kube-state-metrics/"><p>Enabling Seccomp on your Prometheus Operator and related Pods</p></a>
                    </li>
                
                    <li>
                        <a href="https://suraj.io/post/"><p>Posts</p></a>
                    </li>
                
                    <li>
                        <a href="https://suraj.io/post/linux-cap-note/"><p>Capabilities on executables</p></a>
                    </li>
                
                    <li>
                        <a href="https://suraj.io/post/root-in-container-root-on-host/"><p>Root user inside container is root on the host</p></a>
                    </li>
                
                    <li>
                        <a href="https://suraj.io/post/project-specific-scripts/"><p>Project specific scripts</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f&text=Add%20new%20Node%20to%20k8s%20cluster%20with%20Bootstrap%20token&via=surajd_" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f&title=Add%20new%20Node%20to%20k8s%20cluster%20with%20Bootstrap%20token" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f&title=Add%20new%20Node%20to%20k8s%20cluster%20with%20Bootstrap%20token" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f&title=Add%20new%20Node%20to%20k8s%20cluster%20with%20Bootstrap%20token" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Suraj%20Deshmukh&body=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
    <header>
    <div class="title">
        
            <h1><a href="https://suraj.io/post/add-new-k8s-node-bootstrap-token/">Add new Node to k8s cluster with Bootstrap token</a></h1>
            
        
        
            <p>Use this technique to add new node to the cluster without providing any certificates and without having to restart the kube-apiserver</p>
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2018-10-24'>
            October 24, 2018</time>
        <span class="author">Suraj Deshmukh</span>
        
            <p>4 minute read</p>
        
        
    </div>
</header>


    <section id="social-share">
        <ul class="icons">
            


<li><a href="//twitter.com/share?url=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f&text=Add%20new%20Node%20to%20k8s%20cluster%20with%20Bootstrap%20token&via=surajd_" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f&title=Add%20new%20Node%20to%20k8s%20cluster%20with%20Bootstrap%20token" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f&title=Add%20new%20Node%20to%20k8s%20cluster%20with%20Bootstrap%20token" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f&title=Add%20new%20Node%20to%20k8s%20cluster%20with%20Bootstrap%20token" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Suraj%20Deshmukh&body=https%3a%2f%2fsuraj.io%2fpost%2fadd-new-k8s-node-bootstrap-token%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
    

    <div id="content">
        <p>Few days back I wrote a blog about <a href="https://suraj.io/post/add-new-k8s-node-cert-rotate/">adding new node to the cluster</a> using the static token file. The problem with that approach is that you need to restart <code>kube-apiserver</code> providing it the path to the token file. Here we will see how to use the bootstrap token, which is very dynamic in nature and can be controlled by using Kubernetes resources like <code>secrets</code>.</p>
<p>So if you are following <a href="https://github.com/kelseyhightower/kubernetes-the-hard-way/">Kubernetes the Hard Way</a> to set up the cluster here are the changes you should do to adapt it to run with bootstrap token.</p>
<h1 id="master-node-changes">Master Node changes</h1>
<h2 id="kube-apiserver">kube-apiserver</h2>
<p>Add this flag <code>--enable-bootstrap-token-auth=true</code> to your <code>kube-apiserver</code> service file. In the end your service file should look like following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/systemd/system/kube-apiserver.service
</span><span style="color:#e6db74">[Unit]
</span><span style="color:#e6db74">Description=Kubernetes API Server
</span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[Service]
</span><span style="color:#e6db74">ExecStart=/usr/local/bin/kube-apiserver \\
</span><span style="color:#e6db74">  --advertise-address=${INTERNAL_IP} \\
</span><span style="color:#e6db74">  --allow-privileged=true \\
</span><span style="color:#e6db74">  --apiserver-count=3 \\
</span><span style="color:#e6db74">  --audit-log-maxage=30 \\
</span><span style="color:#e6db74">  --audit-log-maxbackup=3 \\
</span><span style="color:#e6db74">  --audit-log-maxsize=100 \\
</span><span style="color:#e6db74">  --audit-log-path=/var/log/audit.log \\
</span><span style="color:#e6db74">  --authorization-mode=Node,RBAC \\
</span><span style="color:#e6db74">  --bind-address=0.0.0.0 \\
</span><span style="color:#e6db74">  --client-ca-file=/var/lib/kubernetes/ca.pem \\
</span><span style="color:#e6db74">  --enable-admission-plugins=Initializers,NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\
</span><span style="color:#e6db74">  --enable-bootstrap-token-auth=true \\
</span><span style="color:#e6db74">  --enable-swagger-ui=true \\
</span><span style="color:#e6db74">  --etcd-cafile=/var/lib/kubernetes/ca.pem \\
</span><span style="color:#e6db74">  --etcd-certfile=/var/lib/kubernetes/kubernetes.pem \\
</span><span style="color:#e6db74">  --etcd-keyfile=/var/lib/kubernetes/kubernetes-key.pem \\
</span><span style="color:#e6db74">  --etcd-servers=https://192.168.50.10:2379 \\
</span><span style="color:#e6db74">  --event-ttl=1h \\
</span><span style="color:#e6db74">  --experimental-encryption-provider-config=/var/lib/kubernetes/encryption-config.yaml \\
</span><span style="color:#e6db74">  --kubelet-certificate-authority=/var/lib/kubernetes/ca.pem \\
</span><span style="color:#e6db74">  --kubelet-client-certificate=/var/lib/kubernetes/kubernetes.pem \\
</span><span style="color:#e6db74">  --kubelet-client-key=/var/lib/kubernetes/kubernetes-key.pem \\
</span><span style="color:#e6db74">  --kubelet-https=true \\
</span><span style="color:#e6db74">  --runtime-config=api/all \\
</span><span style="color:#e6db74">  --service-account-key-file=/var/lib/kubernetes/service-account.pem \\
</span><span style="color:#e6db74">  --service-cluster-ip-range=10.32.0.0/24 \\
</span><span style="color:#e6db74">  --service-node-port-range=30000-32767 \\
</span><span style="color:#e6db74">  --tls-cert-file=/var/lib/kubernetes/kubernetes.pem \\
</span><span style="color:#e6db74">  --tls-private-key-file=/var/lib/kubernetes/kubernetes-key.pem \\
</span><span style="color:#e6db74">  --v=2
</span><span style="color:#e6db74">Restart=on-failure
</span><span style="color:#e6db74">RestartSec=5
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[Install]
</span><span style="color:#e6db74">WantedBy=multi-user.target
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><h2 id="kube-controller-manager">kube-controller-manager</h2>
<p>Add following flag <code>--controllers=*,bootstrapsigner,tokencleaner</code> to the controller manager service file. So service file should look like following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/systemd/system/kube-controller-manager.service
</span><span style="color:#e6db74">[Unit]
</span><span style="color:#e6db74">Description=Kubernetes Controller Manager
</span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[Service]
</span><span style="color:#e6db74">ExecStart=/usr/local/bin/kube-controller-manager \\
</span><span style="color:#e6db74">  --address=0.0.0.0 \\
</span><span style="color:#e6db74">  --cluster-cidr=10.200.0.0/16 \\
</span><span style="color:#e6db74">  --cluster-name=kubernetes \\
</span><span style="color:#e6db74">  --cluster-signing-cert-file=/var/lib/kubernetes/ca.pem \\
</span><span style="color:#e6db74">  --cluster-signing-key-file=/var/lib/kubernetes/ca-key.pem \\
</span><span style="color:#e6db74">  --controllers=*,bootstrapsigner,tokencleaner \\
</span><span style="color:#e6db74">  --kubeconfig=/var/lib/kubernetes/kube-controller-manager.kubeconfig \\
</span><span style="color:#e6db74">  --leader-elect=true \\
</span><span style="color:#e6db74">  --root-ca-file=/var/lib/kubernetes/ca.pem \\
</span><span style="color:#e6db74">  --service-account-private-key-file=/var/lib/kubernetes/service-account-key.pem \\
</span><span style="color:#e6db74">  --service-cluster-ip-range=10.32.0.0/24 \\
</span><span style="color:#e6db74">  --use-service-account-credentials=true \\
</span><span style="color:#e6db74">  --v=2
</span><span style="color:#e6db74">Restart=on-failure
</span><span style="color:#e6db74">RestartSec=5
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[Install]
</span><span style="color:#e6db74">WantedBy=multi-user.target
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><h2 id="bootstrap-secret">Bootstrap secret</h2>
<p>The bootstrap token that we are using to setup is <code>07401b.f395accd246ae52d</code>(You can generate one of yourself). This token has two parts <code>07401b</code> which is public id and private part <code>f395accd246ae52d</code> a secret. Read more about the token, what is allowed and what it should look like <a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#enabling-bootstrap-token-authentication">here</a>. And about the bootstrap token secret format <a href="https://kubernetes.io/docs/reference/access-authn-authz/bootstrap-tokens/#bootstrap-token-secret-format">here</a>.</p>
<p>Create following secret which has certain requirements. The name of the secret should of the format <code>bootstrap-token-&lt;token public id&gt;</code> and should be available in <code>kube-system</code> namespace.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#e6db74">&lt;&lt;EOF | kubectl apply --kubeconfig admin.kubeconfig -f -
</span><span style="color:#e6db74">apiVersion: v1
</span><span style="color:#e6db74">kind: Secret
</span><span style="color:#e6db74">metadata:
</span><span style="color:#e6db74">  # Name MUST be of form &#34;bootstrap-token-&lt;token id&gt;&#34;
</span><span style="color:#e6db74">  name: bootstrap-token-07401b
</span><span style="color:#e6db74">  namespace: kube-system
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"># Type MUST be &#39;bootstrap.kubernetes.io/token&#39;
</span><span style="color:#e6db74">type: bootstrap.kubernetes.io/token
</span><span style="color:#e6db74">stringData:
</span><span style="color:#e6db74">  # Human readable description. Optional.
</span><span style="color:#e6db74">  description: &#34;Created for Kubernetes the Hard Way&#34;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  # Token ID and secret. Required.
</span><span style="color:#e6db74">  token-id: 07401b
</span><span style="color:#e6db74">  token-secret: f395accd246ae52d
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">  # Allowed usages.
</span><span style="color:#e6db74">  usage-bootstrap-authentication: &#34;true&#34;
</span><span style="color:#e6db74">  usage-bootstrap-signing: &#34;true&#34;
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><h2 id="rbac-policies-to-enable-bootstrapping">RBAC policies to enable bootstrapping</h2>
<p>The user authenticated by that token belongs to the group <code>system:bootstrappers</code>, that is why following permissions are given to that group.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl create clusterrolebinding kubelet-bootstrap <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --clusterrole<span style="color:#f92672">=</span>system:node-bootstrapper <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --group<span style="color:#f92672">=</span>system:bootstrappers

kubectl create clusterrolebinding node-autoapprove-bootstrap <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --clusterrole<span style="color:#f92672">=</span>system:certificates.k8s.io:certificatesigningrequests:nodeclient <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --group<span style="color:#f92672">=</span>system:bootstrappers

kubectl create clusterrolebinding node-autoapprove-certificate-rotation <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --clusterrole<span style="color:#f92672">=</span>system:certificates.k8s.io:certificatesigningrequests:selfnodeclient <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --group<span style="color:#f92672">=</span>system:nodes
</code></pre></div><h1 id="worker-node-changes">Worker node changes</h1>
<h2 id="kubelet">Kubelet</h2>
<p>Add this flag <code>--bootstrap-kubeconfig</code>, it is a path to kubeconfig which we will generate shortly, it contains bootstrap token and information to talk to the <code>kube-apiserver</code>. And also you don&rsquo;t need to provide <code>--kubeconfig</code> but provide a path to it, this will be auto-generated and saved at that path.</p>
<p>Your kubelet service file should look like following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /etc/systemd/system/kubelet.service
</span><span style="color:#e6db74">[Unit]
</span><span style="color:#e6db74">Description=Kubernetes Kubelet
</span><span style="color:#e6db74">Documentation=https://github.com/kubernetes/kubernetes
</span><span style="color:#e6db74">After=containerd.service
</span><span style="color:#e6db74">Requires=containerd.service
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[Service]
</span><span style="color:#e6db74">ExecStart=/usr/local/bin/kubelet \\
</span><span style="color:#e6db74">  --bootstrap-kubeconfig=/home/vagrant/bootstrap.kubeconfig \\
</span><span style="color:#e6db74">  --config=/var/lib/kubelet/kubelet-config.yaml \\
</span><span style="color:#e6db74">  --container-runtime=remote \\
</span><span style="color:#e6db74">  --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock \\
</span><span style="color:#e6db74">  --image-pull-progress-deadline=2m \\
</span><span style="color:#e6db74">  --kubeconfig=/home/vagrant/kubeconfig \\
</span><span style="color:#e6db74">  --network-plugin=cni \\
</span><span style="color:#e6db74">  --register-node=true \\
</span><span style="color:#e6db74">  --v=2
</span><span style="color:#e6db74">Restart=on-failure
</span><span style="color:#e6db74">RestartSec=5
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">[Install]
</span><span style="color:#e6db74">WantedBy=multi-user.target
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p>Now changes in kubelet configuration file</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat <span style="color:#e6db74">&lt;&lt;EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml
</span><span style="color:#e6db74">kind: KubeletConfiguration
</span><span style="color:#e6db74">apiVersion: kubelet.config.k8s.io/v1beta1
</span><span style="color:#e6db74">authentication:
</span><span style="color:#e6db74">  anonymous:
</span><span style="color:#e6db74">    enabled: false
</span><span style="color:#e6db74">  webhook:
</span><span style="color:#e6db74">    enabled: true
</span><span style="color:#e6db74">  x509:
</span><span style="color:#e6db74">    clientCAFile: &#34;/home/vagrant/ca.pem&#34;
</span><span style="color:#e6db74">authorization:
</span><span style="color:#e6db74">  mode: Webhook
</span><span style="color:#e6db74">clusterDomain: &#34;cluster.local&#34;
</span><span style="color:#e6db74">clusterDNS:
</span><span style="color:#e6db74">  - &#34;10.32.0.10&#34;
</span><span style="color:#e6db74">podCIDR: &#34;${POD_CIDR}&#34;
</span><span style="color:#e6db74">rotateCertificates: true
</span><span style="color:#e6db74">runtimeRequestTimeout: &#34;15m&#34;
</span><span style="color:#e6db74">serverTLSBootstrap: true
</span><span style="color:#e6db74">EOF</span>
</code></pre></div><p>Provide appropriate path to <code>clientCAFile</code>. And add two more fields <code>rotateCertificates: true</code> &amp; <code>serverTLSBootstrap: true</code>, this will enable cert rotation.</p>
<h2 id="create-bootstrap-kubeconfig">Create bootstrap kubeconfig</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># I have used the ip address of my kube kube-apiserver use yours</span>
kubectl config set-cluster kthwkinvolk <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --certificate-authority<span style="color:#f92672">=</span>ca.pem <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --embed-certs<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --server<span style="color:#f92672">=</span>https://192.168.50.10:6443 <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>/home/vagrant/bootstrap.kubeconfig

<span style="color:#75715e"># this token is above generated</span>
kubectl config set-credentials kubelet-bootstrap <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --token<span style="color:#f92672">=</span>07401b.f395accd246ae52d <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>/home/vagrant/bootstrap.kubeconfig

kubectl config set-context default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --cluster<span style="color:#f92672">=</span>kthwkinvolk <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --user<span style="color:#f92672">=</span>kubelet-bootstrap <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>/home/vagrant/bootstrap.kubeconfig

kubectl config use-context default <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>  --kubeconfig<span style="color:#f92672">=</span>/home/vagrant/bootstrap.kubeconfig
</code></pre></div><p>This is the bootstrap config file which we referred earlier in kubelet service file.</p>
<p>Now once you start <code>kubelet</code> service it will use the bootstrap token in the initial request and fetch the certificates.</p>
<h1 id="trying-it-all-in-one-go">Trying it all in one go</h1>
<p>Here is the <a href="https://gist.github.com/surajssd/71892b7a9c5c2cb175fd050cee45d495">link to the gist</a> where you can start a master and a node using Vagrant and create cluster using above setup.</p>
<p>Hope that helps. Happy Hacking.</p>

    </div>

    <footer>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    

                    
                        Category
                    
                
            </li>
        
    

    
    
        <li><a href='/categorieskubernetes'>kubernetes</a></li>
    
</ul>

    </footer>
</article>
<ul class="actions pagination">
    
        <li><a href="https://suraj.io/post/psp-on-existing-cluster/"
                class="button big previous">PodSecurityPolicy on existing Kubernetes clusters</a></li>
    

    
        <li><a href="https://suraj.io/post/old-laptop-setup/"
                class="button big next">Old laptop setup reference</a></li>
    
</ul>



    
        <article class="post">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "suraj-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>
    


    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
                
                    <a href="/" class="logo"><img src="https://github.com/surajssd.png" alt="Suraj" /></a>
                
            
            
                <header>
                    <h2>Blog</h2>
                    <p>containers, packaging, programming, hacks, kubernetes, openshift, fedora, centos</p>
                </header>
            
            <ul class="icons">
                
                
                    
<li><a href="//github.com/surajssd" target="_blank" title="GitHub" class="fa fa-github"></a></li>





















<li><a href="//youtube.com/surajssd009005" target="_blank" title="YouTube" class="fa fa-youtube"></a></li>









<li><a href="//deshmukhsuraj.wordpress.com" target="_blank" title="WordPress" class="fa fa-wordpress"></a></li>







<li><a href="//linkedin.com/in/suraj-deshmukh-0205b834" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>



<li><a href="//slideshare.com/surajssd009005" target="_blank" title="SlideShare" class="fa fa-slideshare"></a></li>



<li><a href="//stackoverflow.com/users/3848679/surajd" target="_blank" title="Stack Overflow" class="fa fa-stack-overflow"></a></li>











<li><a href="//twitter.com/surajd_" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>



<li><a href="mailto:surajd.service@gmail.com" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>
        </section>

    
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://suraj.io/post/seccomp-in-kube-state-metrics/">Enabling Seccomp on your Prometheus Operator and related Pods</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2020-04-14'>
                                    April 14, 2020</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://suraj.io/post/">Posts</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2020-04-14'>
                                    April 14, 2020</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://suraj.io/post/linux-cap-note/">Capabilities on executables</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2019-06-25'>
                                    June 25, 2019</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://suraj.io/post/root-in-container-root-on-host/">Root user inside container is root on the host</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2019-06-25'>
                                    June 25, 2019</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="https://suraj.io/post/project-specific-scripts/">Project specific scripts</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2019-06-23'>
                                    June 23, 2019</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                "/post/"
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>

    
    
    
    
        <section id="categories">
            <ul class="posts">
                <header>
                    <h3><a href="/categories/">Categories</a></h3>
                </header>

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/kubernetes/">kubernetes</a>
                                <span style="float:right;">17</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/notes/">notes</a>
                                <span style="float:right;">14</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/security/">security</a>
                                <span style="float:right;">7</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/event_report/">event_report</a>
                                <span style="float:right;">5</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/docker/">docker</a>
                                <span style="float:right;">4</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/golang/">golang</a>
                                <span style="float:right;">4</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/host/">host</a>
                                <span style="float:right;">4</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/containers/">containers</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/kompose/">kompose</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/openshift/">openshift</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/packaging/">packaging</a>
                                <span style="float:right;">3</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/fedora/">fedora</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/ide/">ide</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/minikube/">minikube</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/programming/">programming</a>
                                <span style="float:right;">2</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/centos/">centos</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/certs/">certs</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/cka/">cka</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/cmd-line/">cmd-line</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/container/">container</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/desktop/">desktop</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/etcd/">etcd</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/gaming/">gaming</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/git/">git</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/gnome/">gnome</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/https/">https</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/linux/">linux</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/monitoring/">monitoring</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/project_management/">project_management</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/prometheus/">prometheus</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/selinux/">selinux</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/talks/">talks</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <a href="/categories/vagrant/">vagrant</a>
                                <span style="float:right;">1</span>
                            </header>
                        </article>
                    </li>
                
            </ul>
        </section>
    

    
        
        <section class="blurb">
            <h2>About</h2>
            <p>I am a Software Engineer at Kinvolk, working on various tooling around container technology like Docker, Kubernetes</p>

            <ul class="actions">
                <li><a href="/about/" class="button">Learn More</a></li>
            </ul>
        </section>
        

    
        <section id="footer">
            <ul class="icons">
                
                
                    
<li><a href="//github.com/surajssd" target="_blank" title="GitHub" class="fa fa-github"></a></li>





















<li><a href="//youtube.com/surajssd009005" target="_blank" title="YouTube" class="fa fa-youtube"></a></li>









<li><a href="//deshmukhsuraj.wordpress.com" target="_blank" title="WordPress" class="fa fa-wordpress"></a></li>







<li><a href="//linkedin.com/in/suraj-deshmukh-0205b834" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>



<li><a href="//slideshare.com/surajssd009005" target="_blank" title="SlideShare" class="fa fa-slideshare"></a></li>



<li><a href="//stackoverflow.com/users/3848679/surajd" target="_blank" title="Stack Overflow" class="fa fa-stack-overflow"></a></li>











<li><a href="//twitter.com/surajd_" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>



<li><a href="mailto:surajd.service@gmail.com" title="Email" class="fa fa-envelope"></a></li>


                
            </ul>

            <p class="copyright">&copy; Suraj Deshmukh. Design: <a href="http://html5up.net" target="_blank">HTML5 UP</a>. Ported by <a href="//github.com/jpescador" target="_blank">Julio Pescador</a>. Powered by <a href="//gohugo.io" target="_blank">Hugo</a></p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        
        
            
        

        
        
            <script src="/js/jquery.min.js"></script>
            <script src="/js/skel.min.js"></script>
            <script src="/js/util.js"></script>
            <script src="/js/main.js"></script>
            <script src="/js/backToTop.js"></script>
            <script src="/js/highlight.pack.js"></script>
        

        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

